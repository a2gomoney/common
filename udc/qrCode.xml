<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:w2="http://www.inswave.com/websquare" xmlns:xf="http://www.w3.org/2002/xforms">
    <head meta_screenId="qrCode" meta_screenName="QRCode 생성 UDC" meta_screenDesc="QRCode를 생성할 수 있는 UDC">
        <w2:type palette="support">COMPONENT</w2:type>
        <w2:buildDate/>
        <w2:MSA/>
        <xf:model>
            <w2:dataCollection baseNode="map"/>
            <w2:workflowCollection/>
        </xf:model>
        <w2:layoutInfo/>
        <w2:publicInfo method="scwin.generateCode,scwin.url_generate,scwin.vcard_generate,scwin.email_generate,scwin.vcal_generate,scwin.getUrl,scwin.getVcard,scwin.getCalendar,scwin.getDefault,scwin.urlToQrCode,scwin.vcardToQrCode,scwin.vcalendarToQrCode,scwin.generateQrCode,scwin.showQrCode"/>
        <script type="javascript" src="/websquare/_websquare_/externalJS/qrcode/qrcode.js"/>
        <script lazy="false" type="text/javascript"><![CDATA[
/**
 * @component
 * @componentName udc_qrCode
 * @pluginName 
 * @company Inswave
 * @developer Max
 * @category /common/udc
 * @notSupportBrowser 
 * @version
 * @htmlRender
 * @icon
 * @disableIcon
 * @description
 * @width 0%
 * @height 0px
 * @license
 * @imagePath
 * @homepage
 */

/**
 * @property
 * @name id
 * @category 01.Basic & ETC
 * @type string
 * @option
 * @default
 * @necessary N
 * @bindparent
 * @description QRCode UDC 컴포넌트의 id 값.
 */

/**
 * @property
 * @name class
 * @category 01.Basic & ETC
 * @type string
 * @option
 * @default
 * @necessary N
 * @bindparent
 * @description QRCode UDC 컴포넌트에 설정할 CSS Class
 */

/**
 * @property
 * @name style
 * @category 01.Basic & ETC
 * @type string
 * @option
 * @default
 * @necessary N
 * @bindparent
 * @description QRCode UDC 컴포넌트에 in-line으로 설정할 CSS
 */


/**
 * @event
 * @name ongenerateCode
 * @description 코드 생성 시 동작하는 이벤트로 QR 버튼 클릭 직후 일어나는 이벤트.
 * ongenerateCode 이벤트에서 생성할 QRCode에 대한 로직을 작성한다.
 * @example
 */

// url, vcard, vcalendar, default 등의 값을 저장하는 전역 변수.
scwin.valObj = {};

scwin.onpageload = function () {
};


/**
 * @method
 * @name urlToQrCode
 * @description URL 형식의 데이터를 QRCode로 보여준다. URL은 반드시 형식에 맞고, 접속 또는 위치에 접근할 수 있어야 하며,
 * @param {string} url url형식의 문자열
 * @hidden N
 * @exception 
 * @example 
 * const url = window.location.href;
 * udc_qrCode.urlToQrCOde(url);
 */
scwin.urlToQrCode = function (url) {
    let val = {};
    val.status = 'url';

    // url 검사
    if (!$c.util.isEmpty(url) && url.length > 240) {
        $c.win.alert('허용 URL 문자 수를 넘었습니다.');
        return;
    } else if ($c.util.isEmpty(url)) {
        $c.win.alert('url이 비어 있습니다.')
        return;
    } else {
        // 전역 변수 저장
        scwin.valObj.url = url;
        val.url = url;
        scwin.showQrCode(val);
    }
};


/**
 * @method
 * @name vcardToQrCode
 * @description 연락처 저장을 위한 QRCode를 생성한다. 이름, 핸드폰 번호, 이메일, 회사이름을 파라미터로 받으면 
 * 해당 정보에 맞게 생성한다.
 * @param {Object} param 연락처 정보가 저장된 객체
 * @param {string} param.name 연락처에 저장할 이름(성함)
 * @param {string} param.cell 연락처에 저장할 핸드폰 번호
 * @param {string} param.email 연락처에 저장할 이메일 주소
 * @param {string} param.org 연락처에 저장할 상대방의 회사이름
 * @hidden N
 * @exception 
 * @example
 * const tel = { name : "max", cell : "01012345678", email : "max@email.com", org : "inswave"};
 * udc_qrCode.vcardToQrCode( tel );
 */
scwin.vcardToQrCode = function (param) {
    const val = {};
    val.status = 'vcard';

    let vc = "BEGIN:VCARD\n" +
        "VERSION:3.0\n" +
        "FN:" + param.name + "\n" +
        "TEL:" + param.cell + "\n" +
        "EMAIL:" + param.email + "\n" +
        "ORG:" + param.org + "\n" +
        "END:VCARD";

    // 전역변수 저장
    scwin.valObj.vcard = vc;
    val.vcard = vc;
    scwin.showQrCode(val);
}


/**
 * @method
 * @name vcalendarToQrCode
 * @description 일정 정보를 QRCode로 생성한다. 일정 정보 중 dtstart, dtend 의 경우 QRCode가 지원하는 형식에 맞게 작성되어야 한다. (시분초 단위까지)
 * 만들어지는 일정의 시간은 서울 시간대를 따른다.
 * @param {Object} info 일정 정보가 담긴 객체
 * @param {string} info.summary 일정의 타이틀
 * @param {string} info.dtstart 일정시작 시간
 * @param {string} info.dtend 일정종료 시간
 * @param {string} info.description 일정에 대한 설명
 * @hidden N
 * @exception 
 * @example 
 * const schedule = { summary : '휴가', dtstart : '20240830T160000', dtend : '20240830T160000', decription : '휴가 신청' }
 * udc_qrCode.vcalendarToQrCode(schedule);
 */
scwin.vcalendarToQrCode = function (info) {
    // 지정 자리 수 초과 검사.
    if (!$c.util.isEmpty(info.description) && info.description.length > 150) {
        $c.win.alert('일정 설명 지정 자리 수 초과');
        return;
    };

    let cal = {};
    cal.calendar = '';
    cal.calendar += "BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\n";
    cal.calendar += "SUMMARY:" + info.summary + "\n";
    cal.calendar += "DTSTART;TZID=Asia/Seoul:" + info.dtstart + "\n";
    cal.calendar += "DTEND;TZID=Asia/Seoul:" + info.dtend + "\n";
    cal.calendar += "DESCRIPTION:" + info.description + "\n";
    cal.calendar += "END:VEVENT\nEND:VCALENDAR";

    cal.status = 'calendar';

    scwin.valObj.cal = cal;
    scwin.showQrCode(cal);
}


/**
 * @method
 * @name generateQrCode
 * @description default 사용자 정의 방식의 QRCode를 생성하는 메소드
 * 사용자 정의 방식으로 하는 경우 반드시 QRCode가 지원하는 형식으로 parameter를 전달해야함.
 * 그렇지 않을 경우 정상 동작이 안되거나, QRCode 생성에 실패할 수 있음.
 * 데이터는 문자열로 전달해야함. (vcard, vcalendar 등의 형식이 적용된 문자열)
 * @param {string} param 사용자가 QRCode로 생성하기 위한 데이터를 담은 문자열 
 * @hidden N
 * @exception 
 * @example udc_qrCode.generateQrCode(param);
 */
scwin.generateQrCode = function (param) {
    // 입력 데이터 제한 
    const limit = 271;

    if (!isMaxData(param, limit)) {
        $c.win.alert('입력 데이터 최대 허용량 초과');
        return;
    } else {
        // QRCode 보여주기
        scwin.showQrCode(param);
    }

    // 최대 허용 데이터 검사 내부 함수
    function isMaxData(param, limit) {
        const utf_enc = new TextEncoder();
        const bytes = utf_enc.encode(param);
        return bytes.length <= limit
    }
}


/**
 * @method
 * @name showQrCode
 * @description QRCode 팝업 창을 호출한다.
 * @param {Object | string} param QRCode로 보여줄 데이터 객체
 * @hidden N
 * @exception 
 */
scwin.showQrCode = function (param) {
    // 팝업창 options
    const opts = {
        id: "qrCode",
        type: "wframePopup",
        width: "250",
        height: "300",
        popupName: "QRCode",
        modal: true,
        className: "messagebox"
    };

    const data = {
        "param": param,
        "messageType": "alert",
        "id": "qrCode",
    };

    $c.win.openPopup("/common/udc/qrCode_popup.xml", opts, data);
}


scwin.btn_qr_onclick = function (e) {
    $p.emit("ongenerateCode");
};

/**
 * @method
 * @name getUrl
 * @description URL 기능을 사용해 설정된 url 값을 가져온다.
 * @return {string} url 설정된 url이 담긴 문자열
 * @hidden N
 * @exception 
 * @example ${example}
 */
scwin.getUrl = function () {
    if ($c.util.isEmpty(scwin.valObj.url)) {
        return undefined;
    }
    return scwin.valObj.url;
};

/**
 * @method
 * @name getVcard
 * @description Vcard 기능을 사용해 설정된 vcard의 정보를 가져온다.
 * @hidden N
 * @exception 
 * @example const vc = udc_qrCode.getVcard();
 */
scwin.getVcard = function () {
    if ($c.util.isEmpty(scwin.valObj.vcard)) {
        return undefined;
    }
    return scwin.valObj.vcard;
};

/**
 * @method
 * @name getCalendar
 * @description vCalendar 기능을 사용해 설정된 vCalendar의 정보를 가져온다.
 * @hidden N
 * @exception 
 * @example const const cal = udc_qrCode.getCalendar();
 */
scwin.getCalendar = function () {
    if ($c.util.isEmpty(scwin.valObj.cal)) {
        return undefined;
    }
    return scwin.valObj.cal;
};

/**
 * @method
 * @name getDefault
 * @description default 기능을 사용해 사용자 정의 데이터를 가져온다.
 * @hidden N
 * @exception 
 * @example const param = udc_qrCode.getDefault();
 */
scwin.getDefault = function () {
    if ($c.util.isEmpty(scwin.valObj.info)) {
        return undefined;
    }
    return scwin.valObj.info;
};]]></script>
    </head>
    <body ev:onpageload="scwin.onpageload">
    <xf:trigger class="btn_cm qrcode icon" id="btn_qr" style="" type="button" ev:onclick="scwin.btn_qr_onclick" tooltip="현재 화면에 대한 QRCode를 생성합니다.">
    			<xf:label><![CDATA[]]></xf:label>
    		</xf:trigger></body>
</html>
